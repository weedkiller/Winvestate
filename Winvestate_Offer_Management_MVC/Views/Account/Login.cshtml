@using Winvestate_Offer_Management_MVC.Classes
@model ViewModelBase;
@{
    Layout = null;
}


<!DOCTYPE html>
<html lang=tr>
<!--begin::Head-->
<head>
    <base href="../../../../">
    <meta charset="utf-8" />
    <title>Winvestate Gayrimenkul Teklif Yönetim Paneli</title>
    <meta name="description" content="Login page example" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <link rel="canonical" href="https://keenthemes.com/metronic" />
    <!--begin::Fonts-->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700" />
    <!--end::Fonts-->
    <!--begin::Page Custom Styles(used by this page)-->
    <link href="~/assets/css/pages/login/classic/login-4.css" rel="stylesheet" type="text/css" />
    <!--end::Page Custom Styles-->
    <!--begin::Global Theme Styles(used by all pages)-->
    <link href="~/assets/plugins/global/plugins.bundle.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/plugins/custom/prismjs/prismjs.bundle.css" rel="stylesheet" type="text/css" />
    <link href="~/assets/css/style.bundle.css" rel="stylesheet" type="text/css" />
    <!--end::Global Theme Styles-->
    <!--begin::Layout Themes(used by all pages)-->
    <!--end::Layout Themes-->
    <link rel="shortcut icon" href="~/assets/media/logos/favicon.ico" />
</head>
<!--end::Head-->
<!--begin::Body-->
<body id="kt_body" class="quick-panel-right demo-panel-right offcanvas-right header-fixed header-mobile-fixed subheader-enabled aside-enabled aside-static page-loading">
    <!--begin::Main-->
<div class="d-flex flex-column flex-root">
    <!--begin::Login-->
    <div class="login login-4 login-signin-on d-flex flex-row-fluid" id="kt_login">
        <div class="d-flex flex-center flex-row-fluid bgi-size-cover bgi-position-top bgi-no-repeat" style="background-image: url('/assets/media/bg/bg-3.jpg');">
            <div class="login-form text-center p-7 position-relative overflow-hidden">
                <!--begin::Login Header-->
                <div class="d-flex flex-center mb-15">
                    <a href="#">
                        <img src="~/assets/media/logos/logo_company.png" class="max-h-75px" alt="" />
                    </a>
                </div>
                <!--end::Login Header-->
                <!--begin::Login Sign in form-->
                <div class="login-signin">
                    <div class="mb-20">
                        <h3>Yönetim Paneli Giriş Ekranı</h3>
                        <div class="text-muted font-weight-bold">Hesap bilgilerini giriniz</div>
                    </div>
                    <form class="form" id="kt_login_signin_form">
                        <div class="form-group mb-5">
                            <input class="form-control h-auto form-control-solid py-4 px-8" type="text" placeholder="Telefon Numarası" name="phone" id="phone" value="@Model.User.phone" autocomplete="off" />
                        </div>
                        <div class="form-group mb-5">
                            <input class="form-control h-auto form-control-solid py-4 px-8" type="password" placeholder="Şifre" name="password" id="password" value="@Model.User.password" />
                        </div>
                        <div class="form-group d-flex flex-wrap justify-content-between align-items-center">
                            <div class="checkbox-inline">
                                <label class="checkbox m-0 text-muted">
                                    <input type="checkbox" name="remember" />
                                    <span></span>Beni Hatırla
                                </label>
                            </div>
                            <a href="javascript:;" id="kt_login_forgot" class="text-muted text-hover-primary">Şifreni mi unuttun ?</a>
                        </div>
                        <div id="alertInSignIn" role="alert"></div>
                        <button id="kt_login_signin_submit" class="btn btn-dark font-weight-bold px-9 py-4 my-3 mx-4">Giriş Yap</button>

                    </form>
                </div>
                <!--end::Login Sign in form-->
                <!--begin::Login forgot password form-->
                <div class="login-forgot">
                    <div class="mb-20">
                        <h3>Şifre Sıfırlama ?</h3>
                        <div class="text-muted font-weight-bold">Lütfen sisteme kayıtlı cep telefonunuzu giriniz</div>
                    </div>
                    <form class="form" id="kt_login_forgot_form">
                        <div class="form-group mb-10">
                            <input class="form-control form-control-solid h-auto py-4 px-8" type="text" placeholder="Cep Telefonu" name="forgot_phone" id="forgot_phone" autocomplete="off" />
                        </div>
                        <div class="form-group d-flex flex-wrap flex-center mt-10">
                            <button id="kt_login_forgot_submit" class="btn btn-primary font-weight-bold px-9 py-4 my-3 mx-2">Sıfırla</button>
                            <button id="kt_login_forgot_cancel" class="btn btn-light-primary font-weight-bold px-9 py-4 my-3 mx-2">İptal</button>
                        </div>
                        <div id="alertInForgot" role="alert"></div>
                    </form>
                </div>
                <!--end::Login forgot password form-->
            </div>
        </div>
    </div>
    <!--end::Login-->
</div>

<div class="modal fade" id="ModalForUpdatePassword" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Şifre Güncelleme</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <i aria-hidden="true" class="ki ki-close"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="priceForm">
                    <div class="card-body">
                        <div class="form-group row">
                            <label>Şifre</label>
                            <input type="password" class="form-control" name="passwordToUpdate" id="passwordToUpdate"/>
                        </div>
                        <div class="form-group row">
                            <label>Şifre Tekrar</label>
                            <input type="password" class="form-control" name="passwordToUpdate2" id="passwordToUpdate2"/>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="updatePassword">Kaydet</button>
            </div>
        </div>
    </div>
</div>

@Html.Partial("~/Views/Shared/Otp.cshtml", Model)

    <!--end::Main-->
    <script>var HOST_URL = "https://preview.keenthemes.com/metronic/theme/html/tools/preview";</script>
    <!--begin::Global Config(global config for global JS scripts)-->
    <script>var KTAppSettings = { "breakpoints": { "sm": 576, "md": 768, "lg": 992, "xl": 1200, "xxl": 1200 }, "colors": { "theme": { "base": { "white": "#ffffff", "primary": "#6993FF", "secondary": "#E5EAEE", "success": "#1BC5BD", "info": "#8950FC", "warning": "#FFA800", "danger": "#F64E60", "light": "#F3F6F9", "dark": "#212121" }, "light": { "white": "#ffffff", "primary": "#E1E9FF", "secondary": "#ECF0F3", "success": "#C9F7F5", "info": "#EEE5FF", "warning": "#FFF4DE", "danger": "#FFE2E5", "light": "#F3F6F9", "dark": "#D6D6E0" }, "inverse": { "white": "#ffffff", "primary": "#ffffff", "secondary": "#212121", "success": "#ffffff", "info": "#ffffff", "warning": "#ffffff", "danger": "#ffffff", "light": "#464E5F", "dark": "#ffffff" } }, "gray": { "gray-100": "#F3F6F9", "gray-200": "#ECF0F3", "gray-300": "#E5EAEE", "gray-400": "#D6D6E0", "gray-500": "#B5B5C3", "gray-600": "#80808F", "gray-700": "#464E5F", "gray-800": "#1B283F", "gray-900": "#212121" } }, "font-family": "Poppins" };</script>
    <!--end::Global Config-->
    <!--begin::Global Theme Bundle(used by all pages)-->
    <script src="~/assets/plugins/global/plugins.bundle.js"></script>
    <script src="~/assets/plugins/custom/prismjs/prismjs.bundle.js"></script>
    <script src="~/assets/js/scripts.bundle.js"></script>
    <!--end::Global Theme Bundle-->
    <!--begin::Page Scripts(used by this page)-->
    <script src="~/assets/js/helper.js"></script>
    <script src="~/assets/js/otp.js"></script>
    <!--end::Page Scripts-->

    <script>
        var myIti;
        var _myPhone;
        var _login;
        jQuery(document).ready(function () {
            $(".alert").hide();
            KTLogin.init();
        });

        $("#password").keypress(function(event) {
            if (event.keyCode === 13) {
                $('#kt_login_signin_submit').click();
            }
        });

        $("#phone").keypress(function(event) {
            if (event.keyCode === 13) {
                $('#kt_login_signin_submit').click();
            }
        });

        function clearLogin() {
            $("#phone").val("");
            $("#password").val("");
        }

        function clearRegister() {
            $("#email").val("");
            $("#password").val("");
            $("#cpassword").val("");
            $("#name").val("");
            $("#surname").val("");
            $("#phone").val("");
        }

        $('#updatePassword').on('click', function (e) {
            e.preventDefault();

            var loPasswordToUpdate = $("#passwordToUpdate").val();

            if (loPasswordToUpdate.length < 8) {
                swal.fire({
                    "title": "Hata",
                    "text": "Şifreniz en az 8 karakter olmalıdır.",
                    "icon": "error",
                    //"confirmButtonClass": "btn btn-secondary"
                }).then(result => {
                    if (result.value) {

                    }
                });
            }

            else if (loPasswordToUpdate != $("#passwordToUpdate2").val()) {
                swal.fire({
                    "title": "Hata",
                    "text": "Girmiş olduğunuz Şifreler Uyuşmamaktadır.",
                    "icon": "error",
                    //"confirmButtonClass": "btn btn-secondary"
                }).then(result => {
                    if (result.value) {

                    }
                });
            } else {
                var model = {};
                model.password = MD5(loPasswordToUpdate);
                model.phone = _myPhone;
                UpdateUserPassword(model);
            }

        });


        var _showForm = function (form) {
            $(".alert").hide();
            clearLogin();
            clearRegister();
            var cls = 'login-' + form + '-on';
            var form = 'kt_login_' + form + '_form';

            _login.removeClass('login-forgot-on');
            _login.removeClass('login-signin-on');
            _login.removeClass('login-signup-on');

            _login.addClass(cls);

            KTUtil.animateClass(KTUtil.getById(form), 'animate__animated animate__backInUp');
        }

        "use strict";

        // Class Definition
        var KTLogin = function () {




            var _handleSignInForm = function () {
                var validation;

                // Init form validation rules. For more info check the FormValidation plugin's official documentation:https://formvalidation.io/
                validation = FormValidation.formValidation(
                    KTUtil.getById('kt_login_signin_form'),
                    {
                        fields: {
                            phone: {
                                validators: {
                                    notEmpty: {
                                        message: 'Lütfen sisteme kayıtlı cep telefonunuzu giriniz'
                                    }
                                }
                            },
                            password: {
                                validators: {
                                    notEmpty: {
                                        message: 'Lütfen şifrenizi giriniz'
                                    }
                                }
                            }
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            submitButton: new FormValidation.plugins.SubmitButton(),
                            //defaultSubmit: new FormValidation.plugins.DefaultSubmit(), // Uncomment this line to enable normal button submit after form validation
                            bootstrap: new FormValidation.plugins.Bootstrap()
                        }
                    }
                );

                $('#kt_login_signin_submit').on('click', function (e) {
                    e.preventDefault();

                    validation.validate().then(function (status) {
                        if (status == 'Valid') {
                            var model = objectifyForm($('#kt_login_signin_form').serializeArray());
                            var form = $('#kt_login_signin_submit').closest('form')[0];
                            $('#kt_login_signin_submit').addClass('spinner spinner-right spinner-white pr-15').attr('disabled', true).text("Lütfen Bekleyiniz");

                            model.password = MD5(model.password);
                            //model.remember_me = $("#rememberMe").is(":checked");

                            $.ajax({
                                url: '/Account/Validate',
                                method: 'POST',
                                data: { pUser: model },
                                //dataType: 'json',
                                //contentType: 'application/json; charset=utf-8',
                                error: function (xhr) {
                                    $('#kt_login_signin_submit').removeClass('spinner spinner-right spinner-white pr-15').attr('disabled', false).text("Giriş Yap");
                                    showErrorMsg($("#alertInSignIn"),
                                        "Kullanıcı adın ve şifeniz doğrulanamadı. Lütfen daha sonra tekrar deneyiniz.");
                                },
                                success: function (response, status, xhr, $form) {
                                    $(".alert").hide();
                                    $('#kt_login_signin_submit').removeClass('spinner spinner-right spinner-white pr-15').attr('disabled', false).text("Giriş Yap");
                                    if (response.id > 0) {
                                        window.location = '/Home/Dashboard';
                                    } else {
                                        showErrorMsg($("#alertInSignIn"),
                                            "Kullanıcı adı veya şifreniz hatalı. Lütfen kontrol ederek tekrar deneyeniz.");
                                        $('#kt_login_signin_submit').removeClass('spinner spinner-right spinner-white pr-15').attr('disabled', false).text("Giriş Yap");
                                    }

                                    // similate 2s delay
                                    //setTimeout(function() {
                                    //    btn.removeClass('kt-spinner kt-spinner--right kt-spinner--sm kt-spinner--light').attr('disabled', false);
                                    //    showErrorMsg(form, 'danger', 'Incorrect username or password. Please try again.');
                                    //   }, 2000);
                                }
                            });
                        } else {
                            showErrorMsg($("#alertInSignIn"),
                                "Kullanıcı adı veya şifrenizi doldurarak tekrar deneyiniz.");
                        }
                    });
                });

                // Handle forgot button
                $('#kt_login_forgot').on('click', function (e) {
                    e.preventDefault();
                    _showForm('forgot');
                });
            }

            var _handleForgotForm = function (e) {
                var validation;

                // Init form validation rules. For more info check the FormValidation plugin's official documentation:https://formvalidation.io/
                validation = FormValidation.formValidation(
                    KTUtil.getById('kt_login_forgot_form'),
                    {
                        fields: {
                            phone: {
                                validators: {
                                    notEmpty: {
                                        message: 'Cep Telefonu Girilmesi Zorunludur'
                                    },
                                    remote: {

                                        message: 'Bu telefon numarasına ait bir kayıt bulunmamaktadır..',
                                        method: 'POST',
                                        url: '/Account/CheckPhoneHasRegistered',

                                    }
                                }
                            }
                        },
                        plugins: {
                            trigger: new FormValidation.plugins.Trigger(),
                            bootstrap: new FormValidation.plugins.Bootstrap()
                        }
                    }
                );

                // Handle submit button
                $('#kt_login_forgot_submit').on('click', function (e) {
                    e.preventDefault();

                    validation.validate().then(function (status) {
                        if (status == 'Valid') {
                            $(".alert").hide();
                            KTUtil.scrollTop();
                               var loObj = {};
                            loObj.phone = $("#forgot_phone").val();
                            _myPhone = $("#forgot_phone").val();
                            loObj.message_type_system_type_id = 2;
                            sendOtp(loObj, '@Model.Token', $('#kt_login_forgot_submit'), OpenModalForUpdatePassword,'@Common.SendOtpUrl','@Common.ValidateOtpUrl');
                        } else {
                            showErrorMsg($("#alertInForgot"),
                                "Bilgilerinizi kontrol ederek tekrar deneyiniz.");
                        }
                    });
                });

                // Handle cancel button
                $('#kt_login_forgot_cancel').on('click', function (e) {
                    e.preventDefault();

                    _showForm('signin');
                });
            }

            // Public Functions
            return {
                // public functions
                init: function () {
                    _login = $('#kt_login');

                    _handleSignInForm();
                    _handleForgotForm();
                }
            };
        }();

        function OpenModalForUpdatePassword() {
            $("#ModalForUpdatePassword").modal("show");
        }

        function UpdateUserPassword(model) {
            $('#updatePassword').addClass('spinner spinner-right spinner-white pr-15').attr('disabled', true).text("Kaydet");
            $.ajax({
            method: "put",
            url: '@Common.ApiUrl/User/Password',
            contentType: "application/json;charset=utf-8",
                data: JSON.stringify(model),
            traditional: true,
            crossDomain: true,
            dataType: 'json',
            beforeSend: function (xhr) {
                xhr.setRequestHeader('Authorization', 'Bearer @Model.Token');
            },
            error: function () {
                $('#updatePassword').removeClass('spinner spinner-right spinner-white pr-15').attr('disabled', false).text("Kaydet");
                swal.fire({
                    "title": "Hata",
                    "text": "İşlem Tamamlanamadı",
                    "icon": "error",
                    //"confirmButtonClass": "btn btn-secondary"
                }).then(result => {
                    if (result.value) {

                    }
                });
            },
                success: function (data) {
                    $('#updatePassword').removeClass('spinner spinner-right spinner-white pr-15').attr('disabled', false).text("Kaydet");
                if (data.code !== 200) {
                    swal.fire({
                        "title": "Hata",
                        "text": "Şifre Kaydedilemedi. "+data.message,
                        "icon": "error",
                        //"confirmButtonClass": "btn btn-secondary"
                    }).then(result => {
                        if (result.value) {
                        }

                    });
                } else {
                    swal.fire({
                        "title": "Başarılı",
                        "text": "Şifreniz başarıyla güncellendi.",
                        "icon": "success",
                        //"confirmButtonClass": "btn btn-secondary"
                    }).then(result => {
                        if (result.value) {
                            $(".modal").modal("hide");
                            _showForm('signin');
                        }

                    });
                }
            }
        });
        }
    </script>
</body>
<!--end::Body-->
</html>